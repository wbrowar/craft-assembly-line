# Assembly Line
Development and front-end build tools for Craft CMS plugins generated by https://pluginfactory.io.


## Overview
Assembly Line provides an opinionated framework to test and build Craft CMS plugins. It uses [DDEV-Local](https://ddev.readthedocs.io/en/stable/) as a Docker-based local Craft CMS install where your plugin code can be developed and worked on. For plugins that need CSS and JS, Vite is included to bundle front-end assets (however, you can easily swap this out for another build tool).

While Assembly Line can be used with any Craft CMS plugin, its default configuration is set up for plugins generated by [Plugin Factory](https://pluginfactory.io).


## Requirments
- [DDEV-Local](https://ddev.readthedocs.io/en/stable/#installation) installed. This requires Homebrew and Docker Desktop, too.

_NOTE: this is tested to work on macOS 11+. There is currently no support for Windows or Linux._


## Installation and Setup
1. Clone this repo to your local machine.
1. Copy the following files and directories into your plugin directory:
   - .ddev/
   - _source/
   - assembly-line.env
1. The `.gitignore` file in this directory has some basic defaults for most Craft CMS plugin repos along with settings to ignore Assembly Line files. You can replace your plugin’s current `.gitignore` or manually merge them together into your plugin repo’s root directory.
1. If you want to use Vite to build your plugin assets, follow the setup instruction in [Setting up Asset Bundles](#setting-up-asset-bundles).


## Setting up DDEV
Before starting DDEV, some files need to be configured by finding and replacing values THAT_LOOK_LIKE_THIS with configuration specific to your plugin. The setup script that executes when you start DDEV will do some simple checks to make sure these replacements have been made, and from there you can make adjustments to each config file as you'd prefer (for example, setting your preferred docker image or PHP version.).

Here are the replacements that need to happen before working with DDEV:

- Add or replace a variable, called PLUGIN_VENDOR_NAME, in ./assembly-line.env with your plugin vendor name.
- Add or replace a variable, called PLUGIN_PACKAGE_NAME, in ./assembly-line.env with your plugin package name.
- Add or replace a variable, called SITE_URL, in ./assembly-line.env with the same value set for REPLACE_WITH_SITE_URL.test in ./.ddev/config.yaml.
- Replace REPLACE_WITH_PACKAGE_NAME in ./assembly-line.env with your plugin package name.
- Replace REPLACE_WITH_SITE_URL in ./assembly-line.env with the same value set for REPLACE_WITH_SITE_URL.test in ./.ddev/config.yaml.
- Replace REPLACE_WITH_NAME in ./.ddev/config.yaml with a unique name.
- Replace REPLACE_WITH_SITE_URL in ./.ddev/config.yaml with a local testing domain. For example setting this to my-project.test lets you visit this Craft site at https://my-project.test/
- Replace REPLACE_WITH_PACKAGE_NAME in _source/_craft/composer.json with your plugin package name (vendor/name).


## DDEV Commands
Any [DDEV CLI command](https://ddev.readthedocs.io/en/stable/users/cli-usage/) will work. Here are common commands along with a few custom helper commands:

| Command | Notes |
| --- | --- |
| `ddev start` | Starts or restarts the Docker container and runs the setup script at ./.ddev/scripts/setup.sh. If needed, composer install will run and Craft CMS will be set up in the DDEV database. |
| `ddev import-db --src=PATH_TO_SQL_FILE` | Import MySQL-based tables into the container’s default database. After the database is imported, ./.ddev/scripts/setup.sh is run to perform Craft’s CLI commands to `migrate/all`, `project-config/apply`, and `cache/flush-all`. |
| `ddev composer [command]` | Run composer commands, like `composer update`, from the ./_source/_craft/ directory. |
| `ddev craft [command]` | Run Craft CMS console commands using the `./craft` executable in the ./_source/_craft/ directory. |
| `ddev npm [command]` | Run your npm scripts or things like `npm install` from the ./_source/_assets directory. For example, you can build your assets with `ddev npm run build`. |
| `ddev clean-craft` | Wipes out the `vendor` directory, the `composer.lock` file, and some Craft `storage` directories. This command never really needs to be run, but it is safe to run if you want to clear out Craft and re-run `ddev start` for a clean composer install. _NOTE: it doesn’t interact wth the database so Craft will remain installed in the database unless you manually drop tables or nuke everything with `ddev delete`. |
| `ddev clean-craft && ddev start` | Run these commands together after making composer changes will update Craft or any plugins that need updating. |
| `ddev clean-node` | Wipes out the `node_modules` directory and the `package-lock.json` file. |
| `ddev clean-node && ddev start` | Run these commands together after making changes to your `package.json` file will update your npm packages and create a new `package-lock.json` file. |


## Front-end Assets
Assembly Line comes with [Vite](https://vitejs.dev) installed as a default front-end build tool, however, it’s more about the concepts and structure here than Vite or the files you choose to build with it. If you prefer to use Webpack or some other build tool, you can update the files in ./_source/_assets/ with a whole new `package.json` file and set your config to output your files to a directory in your plugin. Like Vite and Webpack, you need something like a `manifest.json` to get the built file names so you can pull them into your plugin.


## Setting up Asset Bundles

First, add this function to your main plugin file. This is mapped to the output of the Vite build and it uses the `manifest.json` file to get the right paths for the hashed file names. Be sure to swap out your paths and plugin class name.

```php
/**
 * Get paths of all JS and CSS files generated by Vite
 *
 * @param string $filename the name of the Vite entry file, usually 'main.ts'
 * @return array
 */
public function getPathsToAssetFiles(string $filename): array
{
    $assetPaths = [
        'css' => [],
        'js' => [],
    ];

    $manifestPath = ExamplePlugin::$plugin->getBasePath() . '/assetbundles/dist/manifest.json';

    if ($manifestPath ?? false) {
        $manifestJson = file_get_contents($manifestPath);

        if ($manifestJson ?? false) {
            $manifest = Json::decodeIfJson($manifestJson);

            if ($manifest && $manifest[$filename]) {
                $path = Craft::$app->getAssetManager()->getPublishedUrl('@somevendor/exampleplugin/assetbundles/dist/', true);
            }
        }
    }

    if ($path ?? false) {
        if ($manifest[$filename]['css'] ?? false) {
            $assetPaths['css'] = $path . '/' . $manifest[$filename]['css'][0];
        }
        if ($manifest[$filename]['file'] ?? false) {
            $assetPaths['js'] = $path . '/' . $manifest[$filename]['file'];
        }
    }

    return $assetPaths;
}
```

---

If you want to register these files as an asset bundle, update your asset bundle to something like this:

```php
namespace somevendor\exampleplugin\assetbundles\exampleplugin;

use craft\web\AssetBundle;
use craft\web\assets\cp\CpAsset;
use somevendor\exampleplugin\ExamplePlugin;

/**
 * @author    Some Vendor
 * @package   ExamplePlugin
 * @since     1.0.0
 */
class ExamplePluginAsset extends AssetBundle
{
    // Public Methods
    // =========================================================================

    /**
     * @inheritdoc
     */
    public function init()
    {
        $this->sourcePath = "@somevendor/exampleplugin/assetbundles/dist";

        $assets = ExamplePlugin::$plugin->getPathsToAssetFiles('main.ts');

        $this->depends = [
            CpAsset::class,
        ];

        $this->js = $assets['js'];

        $this->css = $assets['css'];

        parent::init();
    }
}
```

---

If you want to manually include your files via PHP, you can use `registerCssFile` and/or `registerJsFile` as needed:

```php
$assets = $this->getPathsToAssetFiles('main.ts');
Craft::$app->getView()->registerCssFile($assets['css']);
Craft::$app->getView()->registerJsFile($assets['js'], ['type' => 'module']);
```

_NOTE: Vite will output your JavaScript as ES modules with this setup, so passing `['type' => 'module']` into `registerJsFile` will help load your JS file and its dependencies_

---


## Credits
The DDEV setup was inspired by work by Zach Sackett and Marc Hartwig.